<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Character Sheet - Liam Conroy</title>
	<link rel="stylesheet" href="css/style.css">
	<script type="text/javascript" src="js/paper-full.js"></script>
    <script src="//www.parsecdn.com/js/parse-1.6.12.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script type="text/paperscript" canvas="canvas">
    
    var allSkills = [];

    function Badge(x, y, size, url) 
    {
        var active = false;
        
        this.path = new Path(
        {
            fillColor: 
            {
                hue: Math.random() * 360,
                saturation: 1,
                brightness: 1
            },
            //blendMode: 'screen'
        });

        this.path.strokeColor = 'black';
        this.path.fillColor = 'white';
        this.path.add(new Point(x, y)); 
        this.path.add(new Point(x+size, y)); 
        this.path.add(new Point(x+size, y-size));
        this.path.add(new Point(x, y-size));     
        this.path.closed = true;
        this.path.onMouseDown = function(event) 
        {
            console.log("click!");
            window.open(url, "_blank");
            this.active = true;
        }
    }

    Badge.prototype = 
    {
        update: function()
        {
            if(this.active == true)
                this.scale(1.1, this.bounds.bottomLeft);
        }
    }

    function calculateTotalHours(skillObject)
    {
        var totalHours = 0;

        for(var i = 0; i < skillObject.skills.length; i++)
        {
            allSkills.push(skillObject.skills[i]);
            totalHours += skillObject.skills[i].hours;
        }

        return totalHours;
    }

    function Skill(skillObject, badge) 
    {
        var active = false;
        
        var totalHours = calculateTotalHours(skillObject);

        this.path = new Path.Circle(badge.path.position, totalHours/10);
        this.fillColor = 'black';


        /*this.path = new Path.Circle(
        {
            fillColor: 
            {
                hue: Math.random() * 360,
                saturation: 1,
                brightness: 1
            },
            blendMode: 'screen'
        });*/

        this.path.strokeColor = 'black';
        this.path.fillColor = 'white';
        
        this.path.onMouseDown = function(event) 
        {
            console.log("clickCircle!");   
        }

        this.path.sendToBack();
    }

    Skill.prototype = 
    {
        update: function()
        {
            if(this.active == true)
                this.scale(1.1, this.bounds.bottomLeft);
        }
    }

    var skills;
    var currentProjects;
    var releasedProjects;
    var futureProjects;
    var onHoldProjects;
    var cancelledProjects;

    var badges = [];
    var skillCircles = [];

    var numBadges = 0;
    var numSkillCircles = 0;

    var projectStatuses = ["Current", "Released", "Future", "On Hold", "Decommissioned", "Cancelled"];

    function drawProjectLabels()
    {
        var y = 50;
        var yStep = 70;

        for(var status in projectStatuses)
        {
            var currentProjectsText = new PointText(new Point(10, y));
            currentProjectsText.fillColor = 'black';
            currentProjectsText.content = projectStatuses[status] + ":";

            y+=yStep;
        }
    }

    function drawProjectBoxes()
    {
        var x = 50;
        var y = 80;
        var yStep = 70;
        var xStep = 50;

        var projects = Parse.Object.extend("Projects");
        var query = new Parse.Query(projects);

        var requestsIn = 0;

        for(var i = 0; i < projectStatuses.length; i++)
        {
            query.equalTo("Status", projectStatuses[i]);

            query.find(
            {
                success: function(results) 
                {
                    requestsIn++;

                    for (var j = 0; j < results.length; j++) 
                    { 
                        var project = results[j];
                        //placesOInterest.push(object.get('PlaceName'));
                        var index = projectStatuses.indexOf(project.get('Status')); 
                        var text1 = new PointText(new Point(x+(xStep*j), y+(yStep*index)+20));
                        text1.fillColor = 'black'
                        text1.content = project.get('Name');

                        badges.push(new Badge(x+(xStep*j), y+(yStep*index), 20, project.get('URL')));   
                        numBadges++;

                        skillCircles.push(new Skill(project.get('SkillsUsed'),badges[badges.length - 1]));
                        numSkillCircles++;
                    }

                    /*

                    var developers = [
    { name: "Joe", age: 23 },
    { name: "Sue", age: 28 },
    { name: "Jon", age: 32 },
    { name: "Bob", age: 24 }
], age = 0;

age = developers.reduce(function(memo, developer) {
    return memo + developer.age; // return previous total plus current age
}, 0); // initialize age with 0 that will be passed as memo

console.log("Sum of all developer ages is " + age); 

_.reduce(list, iteratee, [memo], [context]) 

                    */
                    // this should trigger on the last one
                    if(requestsIn == projectStatuses.length)
                    {
                        console.dir(allSkills);

                        var allSkillsUniq = [];

                        allSkills = _.reduce(allSkills, function(memo, skill) 
                        {
                            var index = _.indexOf(memo, skill.skillName);

                            if(index === -1)
                            {
                                //alert(skill.skillName);
                                //console.dir(memo);
                                //console.dir(skill);  
                                memo.push(skill.skillName);
                                allSkillsUniq.push(skill);
                                return memo;
                            }
                            else
                            {
                                //alert(skill.skillName);
                                allSkillsUniq[index].hours += skill.hours;
                                //console.dir(memo);
                                //console.dir(skill);
                            }

                            return memo;
                        }, []);
                    
                        drawSkillLabels(allSkillsUniq);
                        drawSkillBars(allSkillsUniq);
                    }
                },
                error: function(error) 
                {
                    alert("Error: " + error.code + " " + error.message);
                }
            });
        }

        /*var currentProjectsText = new PointText(new Point(10, y));
            currentProjectsText.fillColor = 'black';
            currentProjectsText.content = ;

        

        for(i = 0; i < projects.length; i++)
        {
            
        }*/
    }

    function onFrame(event)
    {
        for(var i = 0; i < numBadges; i++)
        {
            badges[i].update();
        }
        for(var i = 0; i < numSkillCircles; i++)
        {
            skillCircles[i].update();
        }
    }
    
    function initParse()
    {
        Parse.initialize("tpio94gHZkEKpbpxvjCAHKExanIx89VwpIsvtXt5", "aQsoxqb0x8tk09TprScWDnEiZs9SSQFN8qsE3bP1");
    }

    function drawSkillLabels(skills)
    {
        var x = 10;
        var y = 480;
        var yStep = 20;

        for(var skill in skills)
        {
            var skillText = new PointText(new Point(x, y));
            skillText.fillColor = 'black';
            skillText.content = skills[skill].skillName + ":";

            y+=yStep;
        }
    }

    function drawSkillBars(skills)
    {
        var x = 200;
        var y = 480;
        var yStep = 20;
        var barHeight = 10;

        // draw horizontal bars for skills
        for(i = 0; i < skills.length; i++)
        {
            /*var text1 = new PointText(new Point((i*50)+20, 750));
            text1.fillColor = 'black'
            text1.content = skills[i][0]
            text1.rotate(90);*/

            var barHeightDampener = 2;

            var path = new Path();
            path.strokeColor = 'black';
            path.fillColor = 'black';
            path.add(new Point(x, y)); 
            path.add(new Point(x+(skills[i].hours/barHeightDampener), y)); 
            path.add(new Point(x+(skills[i].hours/barHeightDampener), y-barHeight)); 
            path.add(new Point(x, y-barHeight));     
            path.closed = true;

            y+=yStep;
        }
    }

	function main()
	{
        initParse();    
        drawProjectLabels();
        drawProjectBoxes();
	}

	main();

	function onResize(event) 
	{
	// Whenever the window is resized, recenter the path:
		//path.position = view.center;	
	}



	</script>
</head>
<body>
	<canvas id="canvas" resize stats hidpi="off"></canvas>
</body>
</html>