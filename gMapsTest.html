<!--

TODO:
- Put in non-labelled information
- Tweak Zone areas
- Leafy/seasonal shit
- 
-->

<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 100%; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script src="http://www.parsecdn.com/js/parse-1.6.12.min.js"></script>
    <script type="text/javascript">

var map;
var kyotoLoc;

var infowindow;
var service;

function initParse()
{
  Parse.initialize("53KCYXo7suR1lS2dh6WrGPyFJCtqdm56niYgSoev", "v30AM5vsr2asBrbKDeMDWxbhVnDNXYLdOWlgF5Ax");
}

function main()
{
  initParse();
  initMap();
}

function retrievePlacesForArea(area)
{
  var places = Parse.Object.extend("Places");
  var query = new Parse.Query(places);
  query.equalTo("AreaName", area);

  query.find({
    success: function(results) 
    {
      var placesOInterest = [];

      for (var i = 0; i < results.length; i++) 
      {
        var object = results[i];
        placesOInterest.push(object.get('PlaceName'));
      }
      
      findPlaces(placesOInterest);
    },
    error: function(error) 
    {
      alert("Error: " + error.code + " " + error.message);
    }
  });
}

function initAreaFromResult(result)
{
  var area = new google.maps.Rectangle({
    strokeColor: result.get('Color'),
    strokeOpacity: 0.8,
    strokeWeight: 2,
    fillColor: result.get('Color'),
    fillOpacity: 0.35,
    map: map,
    bounds: {
      north: result.get('North'),
      south: result.get('South'),
      east: result.get('East'),
      west: result.get('West')
    }
  });

  area.addListener('click', function() 
  {
    map.fitBounds(area.bounds);
    map.setZoom(result.get('ZoomLevel'));
    retrievePlacesForArea(result.get('AreaName'));
  });
}

function initAreas()
{
  var areas = Parse.Object.extend("Areas");
  var query = new Parse.Query(areas);

  query.find({
    success: function(results) 
    {
      for (var i = 0; i < results.length; i++) 
      {
        initAreaFromResult(results[i]);
      }
    },
    error: function(error) 
    {
      alert("Error: " + error.code + " " + error.message);
    }
  });
}

function initMap() 
{
  kyotoLoc = new google.maps.LatLng(35.01163629999999,135.76802939999993);

  map = new google.maps.Map(document.getElementById('map'), {
    center: kyotoLoc,
    zoom: 12,
    draggable: false,
    scaleControl: false,
    scrollwheel: false,
    disableDoubleClickZoom: true,
    disableDefaultUI: true,
    keyboardShortcuts: false,

  });

  initAreas();
}

function placeDetailsByPlaceId(service, map, infowindow, marker) 
{
  // Create and send the request to obtain details for a specific place,
  // using its Place ID.
  var request = 
  {
    placeId: marker.getPlace().placeId
  };

  service.getDetails(request, function (place, status) 
  {
    if (status == google.maps.places.PlacesServiceStatus.OK) 
    {
      // If the request succeeds, draw the place location on the map
      // as a marker, and register an event to handle a click on the marker.
      
      //google.maps.event.addListener(marker, 'click', function() 
      //{
        infowindow.setContent('<div><strong>' + place.name + '</strong><br>' +
          'Place ID: ' + place.place_id + '<br>' +
          place.formatted_address + '</div>');
        infowindow.open(map, marker);

      //});

      //map.panTo(place.geometry.location);
    }
  });
}

function findPlaces(placesArray)
{
  for (place in placesArray) 
    {
      var request = 
      {
        location: kyotoLoc,
        radius: '10000',
        query: placesArray[place]
      };

      service = new google.maps.places.PlacesService(map);
      service.textSearch(request, findPlacesCallback);
    }
}

function findPlacesCallback(results, status) 
{
  infowindow = new google.maps.InfoWindow();
  service = new google.maps.places.PlacesService(map);

  if (status == google.maps.places.PlacesServiceStatus.OK) 
  {
    for (var i = 0; i < results.length; i++) 
    {
      var marker = new google.maps.Marker(
      {
        map: map,
        place: 
        {
          placeId: results[i].place_id,
          location: results[i].geometry.location
        }
      });

      var x = function () 
      {
        placeDetailsByPlaceId(service, map, infowindow, marker);
      };

      marker.addListener('click', x);
    }
  }
}

    </script>
    <script async defer
      src="http://maps.google.com/maps/api/js?key=AIzaSyBr7DudxLcsuw4LWulpi2X7H25CUktszSg&libraries=places&callback=main">
    </script>
  </body>
</html>







